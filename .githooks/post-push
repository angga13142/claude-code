#!/bin/bash
# Post-push hook - Notifications and cleanup

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo "================================"
echo -e "${GREEN}âœ“ Push completed successfully!${NC}"
echo "================================"

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE_URL=$(git config --get remote.origin.url)
PUSHED_COMMITS=$(git log origin/$CURRENT_BRANCH..HEAD --oneline 2>/dev/null | wc -l || echo "0")

echo ""
echo -e "${BLUE}ðŸ“Š Push Summary:${NC}"
echo "  Branch: $CURRENT_BRANCH"
echo "  Remote: $REMOTE_URL"

if [ "$PUSHED_COMMITS" -gt 0 ]; then
    echo "  Pushed: $PUSHED_COMMITS commit(s)"
else
    echo "  Status: Up to date"
fi

# Show recent commits
if [ "$PUSHED_COMMITS" -gt 0 ]; then
    echo ""
    echo -e "${CYAN}Recent commits:${NC}"
    git log --oneline --max-count=5 origin/$CURRENT_BRANCH..HEAD 2>/dev/null || git log --oneline --max-count=5
fi

# Show diff stats
echo ""
echo -e "${CYAN}Changes pushed:${NC}"
git diff --stat origin/$CURRENT_BRANCH HEAD 2>/dev/null | tail -5 || echo "  (No diff available)"

# Cleanup recommendations
echo ""
echo -e "${BLUE}ðŸ“‹ Post-push recommendations:${NC}"

# Check for old branches
OLD_BRANCHES=$(git branch --merged | grep -v "\*" | grep -v "main" | grep -v "master" | grep -v "$CURRENT_BRANCH" | wc -l || echo "0")
if [ "$OLD_BRANCHES" -gt 0 ]; then
    echo -e "${YELLOW}  âš  You have $OLD_BRANCHES merged branch(es) that can be deleted${NC}"
    echo "    View: git branch --merged"
    echo "    Delete: git branch -d <branch-name>"
fi

# Check for stashes
STASHES=$(git stash list | wc -l || echo "0")
if [ "$STASHES" -gt 0 ]; then
    echo -e "${YELLOW}  âš  You have $STASHES stash(es)${NC}"
    echo "    Review: git stash list"
    echo "    Apply: git stash pop"
fi

# Check for untracked files
UNTRACKED=$(git ls-files --others --exclude-standard | wc -l || echo "0")
if [ "$UNTRACKED" -gt 5 ]; then
    echo -e "${YELLOW}  âš  You have $UNTRACKED untracked file(s)${NC}"
    echo "    Review: git status"
fi

# CI/CD reminder
if [ -d ".github/workflows" ] || [ -f ".gitlab-ci.yml" ] || [ -f "Jenkinsfile" ]; then
    echo "  â„¹ï¸  CI/CD pipeline will run automatically"
    
    # Try to show GitHub Actions URL
    if [[ $REMOTE_URL == *"github.com"* ]]; then
        REPO=$(echo "$REMOTE_URL" | sed -E 's/.*github.com[:/](.*)\.git/\1/' | sed 's/\.git$//')
        echo "    Monitor: https://github.com/$REPO/actions"
    fi
fi

# Pull request reminder
if [[ $CURRENT_BRANCH != "main" ]] && [[ $CURRENT_BRANCH != "master" ]] && [[ $CURRENT_BRANCH != "develop" ]]; then
    echo "  â„¹ï¸  Consider creating a pull request"
    
    if [[ $REMOTE_URL == *"github.com"* ]]; then
        REPO=$(echo "$REMOTE_URL" | sed -E 's/.*github.com[:/](.*)\.git/\1/' | sed 's/\.git$//')
        echo "    URL: https://github.com/$REPO/compare/$CURRENT_BRANCH?expand=1"
    fi
fi

# Documentation reminder
CODE_FILES=$(git diff --name-only HEAD~$PUSHED_COMMITS HEAD 2>/dev/null | grep -E '\.(py|sh|js|ts)$' | wc -l || echo "0")
DOC_FILES=$(git diff --name-only HEAD~$PUSHED_COMMITS HEAD 2>/dev/null | grep -E '\.md$' | wc -l || echo "0")

if [ "$CODE_FILES" -gt 0 ] && [ "$DOC_FILES" -eq 0 ]; then
    echo -e "${YELLOW}  âš  Code changes pushed without documentation updates${NC}"
    echo "    Consider updating README.md or relevant docs"
fi

# Success tips
echo ""
echo -e "${GREEN}ðŸ’¡ Next steps:${NC}"
echo "  â€¢ Review your changes: git log --oneline -5"
echo "  â€¢ Check CI/CD pipeline status"
echo "  â€¢ Update task tracking (if applicable)"

if [[ $CURRENT_BRANCH =~ ^[0-9]+-.*$ ]]; then
    ISSUE_NUM=$(echo "$CURRENT_BRANCH" | grep -oE '^[0-9]+')
    echo "  â€¢ Update issue #$ISSUE_NUM status"
fi

echo ""
echo -e "${GREEN}ðŸŽ‰ Great work! Keep coding!${NC}"
echo ""
