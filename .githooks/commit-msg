#!/bin/bash
# Commit message validation hook
# Enforces conventional commit format

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "▶ Validating commit message..."

# Skip validation for merge commits
if echo "$COMMIT_MSG" | grep -q "^Merge"; then
    echo -e "${GREEN}✓ Merge commit - skipping validation${NC}"
    exit 0
fi

# Check commit message format: type(scope): subject
PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\([a-zA-Z0-9\-]+\))?: .{10,}"

if ! echo "$COMMIT_MSG" | grep -qE "$PATTERN"; then
    echo -e "${RED}✗ Invalid commit message format${NC}"
    echo ""
    echo "Commit message must follow conventional commits:"
    echo "  type(scope): subject"
    echo ""
    echo "Types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style changes (formatting, etc.)"
    echo "  refactor - Code refactoring"
    echo "  perf     - Performance improvements"
    echo "  test     - Adding or updating tests"
    echo "  chore    - Maintenance tasks"
    echo "  build    - Build system changes"
    echo "  ci       - CI/CD changes"
    echo "  revert   - Revert previous commit"
    echo ""
    echo "Examples:"
    echo "  feat(auth): add OAuth2 authentication"
    echo "  fix(api): resolve null pointer in user service"
    echo "  docs(readme): update installation instructions"
    echo "  test(user): add unit tests for user model"
    echo ""
    echo "Your message:"
    echo "  $COMMIT_MSG"
    echo ""
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi

# Check subject length
SUBJECT=$(echo "$COMMIT_MSG" | head -n1)
SUBJECT_LENGTH=${#SUBJECT}

if [ $SUBJECT_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}⚠ Subject line is $SUBJECT_LENGTH chars (recommended max: 72)${NC}"
fi

if [ $SUBJECT_LENGTH -gt 100 ]; then
    echo -e "${RED}✗ Subject line is $SUBJECT_LENGTH chars (hard limit: 100)${NC}"
    exit 1
fi

# Check for imperative mood
if echo "$SUBJECT" | grep -qE ": (added|fixed|updated|changed|removed|created)"; then
    echo -e "${YELLOW}⚠ Use imperative mood: 'add' not 'added', 'fix' not 'fixed'${NC}"
fi

# Check for capitalization
TYPE_AND_SCOPE=$(echo "$SUBJECT" | cut -d: -f1)
MESSAGE=$(echo "$SUBJECT" | cut -d: -f2-)
FIRST_CHAR=$(echo "$MESSAGE" | sed 's/^ *//' | cut -c1)

if echo "$FIRST_CHAR" | grep -q "[A-Z]"; then
    echo -e "${YELLOW}⚠ Subject should start with lowercase letter${NC}"
fi

# Check for period at end
if echo "$SUBJECT" | grep -q "\.$"; then
    echo -e "${YELLOW}⚠ Subject should not end with period${NC}"
fi

# Check body format if exists
BODY=$(echo "$COMMIT_MSG" | tail -n +3)
if [ -n "$BODY" ]; then
    # Check for blank line after subject
    SECOND_LINE=$(echo "$COMMIT_MSG" | sed -n '2p')
    if [ -n "$SECOND_LINE" ]; then
        echo -e "${YELLOW}⚠ Add blank line between subject and body${NC}"
    fi
    
    # Check for line length in body
    LINE_NUM=3
    echo "$BODY" | while IFS= read -r line; do
        if [ ${#line} -gt 72 ]; then
            echo -e "${YELLOW}⚠ Line $LINE_NUM exceeds 72 chars: ${line:0:40}...${NC}"
        fi
        LINE_NUM=$((LINE_NUM + 1))
    done
fi

echo -e "${GREEN}✓ Commit message validated${NC}"
