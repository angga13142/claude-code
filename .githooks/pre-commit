#!/bin/bash
# Pre-commit hook with strict code quality checks
# Prevents commits with code quality issues

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# Check 1: No debug statements
echo "â–¶ Checking for debug statements..."
if git diff --cached --name-only | grep -E '\.(py|sh|md)$' | xargs grep -nE "(print\(.*DEBUG|console\.log\(.*DEBUG)" 2>/dev/null; then
    echo -e "${RED}âœ— Found debug statements${NC}"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“ No debug statements${NC}"
fi

# Check 2: No TODO/FIXME without issue reference
echo "â–¶ Checking TODOs have issue references..."
if git diff --cached --name-only | grep -E '\.(py|sh|md)$' | xargs grep -nE "(TODO|FIXME)(?!.*#[0-9])" 2>/dev/null | grep -v "# TODO" | head -3; then
    echo -e "${YELLOW}âš  Found TODO/FIXME without issue reference${NC}"
    echo "  Please add issue reference: TODO(#123) or FIXME(#123)"
fi

# Check 3: Python - Type hints check
echo "â–¶ Checking Python type hints..."
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
if [ -n "$PYTHON_FILES" ]; then
    for file in $PYTHON_FILES; do
        if [ -f "$file" ]; then
            # Check for functions without type hints (excluding __init__ and __main__)
            MISSING=$(grep -n "^def " "$file" | grep -v -- "-> " | grep -v "__init__" | grep -v "__main__" | head -3 || true)
            if [ -n "$MISSING" ]; then
                echo -e "${YELLOW}âš  Missing type hints in: $file${NC}"
                echo "$MISSING" | head -3
            fi
        fi
    done
fi

# Check 4: Python - Run mypy type checking
if [ -n "$PYTHON_FILES" ]; then
    echo "â–¶ Running mypy type checking..."
    if command -v mypy &> /dev/null; then
        for file in $PYTHON_FILES; do
            if [ -f "$file" ]; then
                if ! mypy --ignore-missing-imports --no-error-summary "$file" 2>&1 | grep -q "Success"; then
                    echo -e "${YELLOW}âš  Type checking warnings in: $file${NC}"
                fi
            fi
        done
        echo -e "${GREEN}âœ“ Type checking completed${NC}"
    else
        echo -e "${YELLOW}âš  mypy not installed, skipping type check${NC}"
        echo "  Install: pip install mypy"
    fi
fi

# Check 5: Python - Run pylint
if [ -n "$PYTHON_FILES" ]; then
    echo "â–¶ Running pylint..."
    if command -v pylint &> /dev/null; then
        for file in $PYTHON_FILES; do
            if [ -f "$file" ]; then
                SCORE=$(pylint --disable=all --enable=F,E,W --score=y "$file" 2>/dev/null | grep "Your code has been rated" | awk '{print $7}' | cut -d'/' -f1 || echo "8.0")
                if [ -n "$SCORE" ] && [ "$SCORE" != "8.0" ]; then
                    if (( $(echo "$SCORE < 7.0" | bc -l 2>/dev/null || echo "0") )); then
                        echo -e "${RED}âœ— Pylint score $SCORE/10.0 for $file (minimum: 7.0)${NC}"
                        ERRORS=$((ERRORS + 1))
                    else
                        echo -e "${GREEN}âœ“ Pylint score $SCORE/10.0 for $file${NC}"
                    fi
                fi
            fi
        done
    else
        echo -e "${YELLOW}âš  pylint not installed, skipping${NC}"
        echo "  Install: pip install pylint"
    fi
fi

# Check 6: Shell scripts - Run shellcheck
echo "â–¶ Checking shell scripts..."
SHELL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)
if [ -n "$SHELL_FILES" ]; then
    if command -v shellcheck &> /dev/null; then
        for file in $SHELL_FILES; do
            if [ -f "$file" ]; then
                if ! shellcheck -x -e SC1091 "$file" 2>&1 | head -10; then
                    echo -e "${YELLOW}âš  Shellcheck warnings for: $file${NC}"
                else
                    echo -e "${GREEN}âœ“ Shellcheck passed for: $file${NC}"
                fi
            fi
        done
    else
        echo -e "${YELLOW}âš  shellcheck not installed${NC}"
        echo "  Install: apt-get install shellcheck (Ubuntu) or brew install shellcheck (macOS)"
    fi
fi

# Check 7: No sensitive data
echo "â–¶ Checking for sensitive data..."
STAGED_FILES=$(git diff --cached --name-only | grep -v "\.githooks/" | grep -v "\.toml$" | grep -v "\.yml$" | grep -v "\.yaml$" || true)
if [ -n "$STAGED_FILES" ]; then
    # Look for actual credential values (long alphanumeric strings after = with quotes)
    # Exclude: parameter names, type hints, function signatures
    SENSITIVE_PATTERNS='(password|secret|api_key|private_key|AWS_ACCESS_KEY|AWS_SECRET_KEY|ANTHROPIC_API_KEY)\s*=\s*["\047][a-zA-Z0-9_-]{32,}["\047]'
    
    # Check each file individually to provide better error messages
    FOUND_SENSITIVE=false
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            if grep -nE "$SENSITIVE_PATTERNS" "$file" 2>/dev/null | head -1; then
                echo -e "${RED}âœ— Found potential sensitive data in: $file${NC}"
                FOUND_SENSITIVE=true
            fi
        fi
    done
    
    if [ "$FOUND_SENSITIVE" = true ]; then
        echo "  Use environment variables or secret managers"
        ERRORS=$((ERRORS + 1))
    else
        echo -e "${GREEN}âœ“ No sensitive data found${NC}"
    fi
else
    echo -e "${GREEN}âœ“ No files to check${NC}"
fi

# Check 8: No large files
echo "â–¶ Checking file sizes..."
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read -r file; do
    if [ -f "$file" ]; then
        SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
        if [ "$SIZE" -gt 1048576 ]; then
            echo "$file ($(echo "scale=2; $SIZE/1048576" | bc)MB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    echo -e "${RED}âœ— Large files detected (>1MB):${NC}"
    echo "$LARGE_FILES"
    echo "  Consider using Git LFS for large files"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}âœ“ No large files${NC}"
fi

# Check 9: YAML validation
echo "â–¶ Validating YAML files..."
YAML_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yaml|yml)$' || true)
if [ -n "$YAML_FILES" ]; then
    if command -v python3 &> /dev/null; then
        for file in $YAML_FILES; do
            if [ -f "$file" ]; then
                if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                    echo -e "${RED}âœ— Invalid YAML: $file${NC}"
                    ERRORS=$((ERRORS + 1))
                else
                    echo -e "${GREEN}âœ“ Valid YAML: $file${NC}"
                fi
            fi
        done
    fi
fi

# Check 10: JSON validation
echo "â–¶ Validating JSON files..."
JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.json$' || true)
if [ -n "$JSON_FILES" ]; then
    for file in $JSON_FILES; do
        if [ -f "$file" ]; then
            if ! python3 -c "import json; json.load(open('$file'))" 2>/dev/null; then
                echo -e "${RED}âœ— Invalid JSON: $file${NC}"
                ERRORS=$((ERRORS + 1))
            else
                echo -e "${GREEN}âœ“ Valid JSON: $file${NC}"
            fi
        fi
    done
fi

# Check 11: Markdown linting
echo "â–¶ Checking markdown files..."
MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' || true)
if [ -n "$MD_FILES" ]; then
    if command -v markdownlint &> /dev/null; then
        for file in $MD_FILES; do
            if [ -f "$file" ]; then
                if ! markdownlint "$file" 2>/dev/null; then
                    echo -e "${YELLOW}âš  Markdown style issues in: $file${NC}"
                fi
            fi
        done
    else
        echo -e "${GREEN}âœ“ Markdown files present (markdownlint not installed)${NC}"
    fi
fi

# Check 12: Trailing whitespace
echo "â–¶ Checking for trailing whitespace..."
if git diff --cached --check 2>&1 | grep -q "trailing whitespace"; then
    echo -e "${YELLOW}âš  Trailing whitespace detected${NC}"
    echo "  Run: git diff --cached --check"
fi

# Summary
echo ""
echo "================================"
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}âœ— Pre-commit checks failed with $ERRORS error(s)${NC}"
    echo "Fix the issues above and try again"
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}âœ“ All pre-commit checks passed!${NC}"
fi
